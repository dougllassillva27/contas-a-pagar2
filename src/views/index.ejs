<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <%- include('partials/head') %>
</head>
<body data-month="<%= nav.atual.month %>" data-year="<%= nav.atual.year %>" data-username="<%= user.nome %>">

    <%- include('partials/header') %>

    <section class="dashboard-cards">
        <div class="card" onclick="abrirModalRendasDetalhes()" style="position: relative;">
            <span class="material-icons card-icon-eye" id="iconEyeRendas" onclick="toggleRendas(event)">visibility</span>
            <h3>Total de Rendas</h3>
            <p class="valor azul" id="valorRendas">R$ <%= Number(totais.totalrendas).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %></p>
            <script>
                if (localStorage.getItem('hideRendas') === 'true') {
                    const el = document.getElementById('valorRendas');
                    const ic = document.getElementById('iconEyeRendas');
                    if(el) el.classList.add('blur-effect');
                    if(ic) ic.innerText = 'visibility_off';
                }
            </script>
        </div>

        <div class="card">
            <h3>Suas Contas</h3>
            <p class="valor vermelho">R$ <%= Number(totais.totalcontas).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %></p>
        </div>
        <div class="card">
            <h3>Falta Pagar</h3>
            <p class="valor laranja">R$ <%= Number(totais.faltapagar).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %></p>
        </div>
        <div class="card">
            <h3>Seu Saldo</h3>
            <p class="valor <%= Number(totais.saldoprevisto) < 0 ? 'vermelho' : 'verde' %>">
                R$ <%= Number(totais.saldoprevisto).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %>
            </p>
        </div>
    </section>

    <div class="action-area">
        <button class="btn-primary" onclick="abrirModalAdicionar()">
            <span class="material-icons">add</span>
            Adicionar Lançamento
        </button>
    </div>

    <div class="main-grid">
        <div class="panel">
            <div class="panel-header"><h2>Anotações</h2><small id="statusSave" style="opacity: 0; color: var(--blue);">Salvo!</small></div>
            <div class="anotacoes-wrapper">
                <textarea id="anotacoesArea" placeholder="Digite aqui..." oninput="salvarAnotacao()"><%= anotacoes %></textarea>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h2>Contas Fixas</h2>
                <span class="total-panel">R$ <%= fixas.filter(i => i.status === 'PENDENTE').reduce((acc, i) => acc + Number(i.valor), 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %></span>
            </div>
            <div class="scroll-wrapper">
                <table class="list-table">
                    <tbody class="drag-container" id="listaFixas">
                        <% fixas.forEach(item => { %>
                        <tr class="draggable-row" draggable="true" data-id="<%= item.id %>">
                            <td width="20"><span class="material-icons drag-handle" style="font-size:16px;">drag_indicator</span></td>
                            <td width="30"><input type="checkbox" onchange="alternarStatus(this, <%= item.id %>)" <%= item.status === 'PAGO' ? 'checked' : '' %>></td>
                            <td><%= item.descricao %></td>
                            <td class="text-right">R$ <%= Number(item.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %></td>
                            <td class="actions">
                                <span class="material-icons" style="font-size:18px;" onclick="editarConta(<%= item.id %>, '<%= item.descricao %>', '<%= Number(item.valor).toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>', 'Fixa', null, null, null)">edit</span>
                                <span class="material-icons" style="font-size:18px;" onclick="confirmarExclusao(<%= item.id %>)">delete</span>
                            </td>
                        </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h2>Suas Contas Cartão</h2>
                <span class="total-panel vermelho">R$ <%= cartao.filter(i => i.status === 'PENDENTE').reduce((acc, i) => acc + Number(i.valor), 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %></span>
            </div>
            <div class="scroll-wrapper">
                <table class="list-table">
                    <tbody class="drag-container" id="listaCartao">
                        <% cartao.forEach(item => { %>
                        <tr class="draggable-row" draggable="true" data-id="<%= item.id %>">
                            <td width="20"><span class="material-icons drag-handle" style="font-size:16px;">drag_indicator</span></td>
                            <td width="30"><input type="checkbox" onchange="alternarStatus(this, <%= item.id %>)" <%= item.status === 'PAGO' ? 'checked' : '' %>></td>
                            <td>
                                <%= item.descricao %>
                                <% if(item.parcelaatual && item.totalparcelas) { %>
                                    <small style="color:var(--text-secondary);">
                                        (<%= String(item.parcelaatual).padStart(2, '0') %>/<%= String(item.totalparcelas).padStart(2, '0') %>)
                                    </small>
                                <% } %>
                            </td>
                            <td class="text-right">R$ <%= Number(item.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %></td>
                            <td class="actions">
                                <span class="material-icons" style="font-size:18px;" onclick="editarConta(<%= item.id %>, '<%= item.descricao %>', '<%= Number(item.valor).toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>', '<%= item.parcelaatual ? 'Parcelada' : 'Única' %>', '<%= item.parcelaatual || '' %>', '<%= item.totalparcelas || '' %>', null)">edit</span>
                                <span class="material-icons" style="font-size:18px;" onclick="confirmarExclusao(<%= item.id %>)">delete</span>
                            </td>
                        </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel">
            <div class="panel-header">
                <h2>Cartão de Crédito</h2>
                <span class="total-panel azul">R$ <%= resumoPessoas.reduce((acc, i) => acc + Number(i.total), 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %></span>
            </div>

            <div class="app-compare-wrapper">
                <span class="app-compare-label">Cartão de Crédito - APP:</span>
                <input type="text" 
                       class="app-compare-input" 
                       value="R$ <%= Number(faturaManual).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %>" 
                       onblur="salvarFaturaManual(this)"
                       onfocus="limparMascara(this)"
                       onkeypress="handleEnterFatura(event, this)">
            </div>

            <div class="scroll-wrapper">
                <% if (resumoPessoas.length === 0) { %>
                    <div style="text-align: center; color: var(--text-secondary); padding: 20px; font-size: 0.9rem;">
                        <p>Nenhum lançamento.</p>
                    </div>
                <% } else { %>
                    <table class="list-table">
                        <% resumoPessoas.forEach(pessoa => { %>
                        <tr>
                            <td width="30" style="color: var(--text-secondary);">
                                <span class="material-icons" style="font-size: 16px; cursor: pointer;" 
                                      onclick="abrirModalCartaoPessoa('<%= pessoa.pessoa %>')">visibility</span>
                            </td>
                            <td style="padding:0;">
                                <span class="trigger-p-nome" 
                                    data-pessoa="<%= pessoa.pessoa %>"
                                    oncontextmenu="abrirMenuContexto(event, '<%= pessoa.pessoa %>')">
                                    <%= pessoa.pessoa %>
                                </span>
                            </td>
                            <td class="text-right" style="font-weight: bold; color: var(--red);">
                                R$ <%= Number(pessoa.total).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %>
                            </td>
                        </tr>
                        <% }) %>
                    </table>
                <% } %>
            </div>
        </div>
    </div>

    <% if (terceiros && terceiros.length > 0) { %>
        <div style="margin: 30px 0 15px 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
            <h2 style="color: var(--text-secondary); font-size: 1.1rem; margin-bottom: 20px;">Painéis de Terceiros</h2>
        </div>

        <div class="terceiros-grid drag-container-cards">
            <% terceiros.forEach(pessoa => { %>
                <div class="panel draggable-card" draggable="true" data-nome="<%= pessoa.nome %>">
                    <div class="panel-header" style="border-bottom: 2px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span class="material-icons drag-handle-card" style="font-size:18px; color:var(--text-secondary);">drag_indicator</span>
                            <h2 style="color: var(--text-primary);"><%= pessoa.nome %></h2>
                        </div>
                        <span class="header-total-mes">Total do mês: <span>R$ <%= Number(pessoa.totalGeral).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %></span></span>
                    </div>

                    <div style="background: rgba(56, 120, 225, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <small style="color: var(--blue); font-weight: bold; text-transform: uppercase; font-size: 0.75rem;">Total Cartão</small>
                            <div style="font-size: 1.4rem; font-weight: bold; color: var(--text-primary);">
                                R$ <%= Number(pessoa.totalCartao).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %>
                            </div>
                        </div>
                        <button class="btn-secondary" style="border: none; background: rgba(0,0,0,0.2);" 
                                onclick="abrirModalCartaoPessoa('<%= pessoa.nome %>')">
                            <span class="material-icons">visibility</span> Ver
                        </button>
                    </div>

                    <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 0.9rem; color: var(--text-secondary);">Contas Fixas</h3>
                        <span style="font-size: 0.9rem; font-weight: bold; color: var(--red);">
                            R$ <%= Number(pessoa.totalFixas).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %>
                        </span>
                    </div>

                    <div class="scroll-wrapper">
                        <% if (pessoa.itensFixas.length === 0) { %>
                            <p style="text-align: center; color: var(--text-secondary); font-size: 0.85rem; padding: 20px;">Nenhuma conta fixa.</p>
                        <% } else { %>
                            <table class="list-table">
                                <tbody class="drag-container" id="listaFixas<%= pessoa.nome.replace(/\s/g, '') %>">
                                    <% pessoa.itensFixas.forEach(item => { %>
                                    <tr class="draggable-row" draggable="true" data-id="<%= item.id %>">
                                        <td width="20"><span class="material-icons drag-handle" style="font-size:16px;">drag_indicator</span></td>
                                        <td width="30"><input type="checkbox" onchange="alternarStatus(this, <%= item.id %>)" <%= item.status === 'PAGO' ? 'checked' : '' %>></td>
                                        <td><%= item.descricao %></td>
                                        <td class="text-right">R$ <%= Number(item.valor).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) %></td>
                                        <td class="actions">
                                            <span class="material-icons" style="font-size:18px;" onclick="editarConta(<%= item.id %>, '<%= item.descricao %>', '<%= Number(item.valor).toLocaleString('pt-BR', {minimumFractionDigits: 2}) %>', 'Fixa', null, null, '<%= pessoa.nome %>')">edit</span>
                                            <span class="material-icons" style="font-size:18px;" onclick="confirmarExclusao(<%= item.id %>)">delete</span>
                                        </td>
                                    </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        <% } %>
                    </div>
                </div>
            <% }) %>
        </div>
    <% } %>

    <%- include('partials/modals') %>

    <script src="/js/app.js"></script>
</body>
</html>